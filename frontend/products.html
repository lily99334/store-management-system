<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>å•†å“ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-light">

    {% raw %}
    <div id="app" class="container py-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-secondary">â¬…ï¸ å›é¦–é </a>
                <h2 class="m-0">ğŸ“¦ å•†å“ç®¡ç†</h2>
            </div>
            <button class="btn btn-primary" @click="openModal('add')">ï¼‹ æ–°å¢å•†å“</button>
        </div>

        <table class="table table-hover bg-white shadow-sm rounded align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>åœ–ç‰‡</th>
                    <th>å“å</th>
                    <th>åˆ†é¡</th>
                    <th>åº«å­˜</th>
                    <th>åƒ¹æ ¼</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="p in products" :key="p.id">
                    <td>[[ p.id ]]</td>
                    <td>
                        <img :src="p.image_url" v-if="p.image_url" style="width: 40px; height: 40px; object-fit: cover;"
                            class="rounded border">
                        <span v-else class="text-muted small">ç„¡</span>
                    </td>
                    <td class="fw-bold">[[ p.name ]]</td>
                    <td><span class="badge bg-secondary">[[ p.category ]]</span></td>

                    <td :class="{'text-danger fw-bold': p.current_stock < p.safe_stock}">
                        [[ p.current_stock ]]
                    </td>

                    <td>$[[ p.price ]]</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" @click="openModal('edit', p)">ç·¨è¼¯</button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteProduct(p.id)">åˆªé™¤</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="modal fade" id="productModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">[[ isEdit ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“' ]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            <label>å“å</label>
                            <input v-model="temp.name" class="form-control">
                        </div>
                        <div class="row mb-2">
                            <div class="col"><label>åˆ†é¡</label><input v-model="temp.category" class="form-control"></div>
                            <div class="col"><label>åƒ¹æ ¼</label><input v-model.number="temp.price" type="number"
                                    class="form-control"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col"><label>åŸºæœ¬ä¿åº•åº«å­˜</label><input v-model.number="temp.safe_stock" type="number"
                                    class="form-control"></div>
                            <div class="col"><label>è£œè²¨å¤©æ•¸</label><input v-model.number="temp.lead_time" type="number"
                                    class="form-control"></div>
                        </div>
                        
                        <div class="mb-2">
                            <label>å•†å“åœ–ç‰‡</label>
                            <input type="file" class="form-control" @change="handleFileUpload" accept="image/*">
                            
                            <div class="mt-2 text-center" v-if="previewImage">
                                <span class="text-muted small d-block mb-1">é è¦½ï¼š</span>
                                <img :src="previewImage" style="max-height: 150px; border-radius: 5px;">
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary w-100" @click="saveProduct">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const { createApp } = Vue
        createApp({
            delimiters: ['[[', ']]'],
            data() { 
                return { 
                    products: [], 
                    temp: {}, 
                    modal: null, 
                    isEdit: false,
                    selectedFile: null, // å­˜ä½¿ç”¨è€…é¸çš„æª”æ¡ˆ
                    previewImage: null  // å­˜é è¦½åœ–ç¶²å€
                } 
            },
            mounted() {
                this.modal = new bootstrap.Modal(document.getElementById('productModal'));
                this.fetchProducts();
            },
            methods: {
                fetchProducts() {
                    axios.get('/api/products').then(res => this.products = res.data);
                },
                openModal(type, product) {
                    this.isEdit = (type === 'edit');
                    this.selectedFile = null; // é‡ç½®æª”æ¡ˆ
                    
                    if (this.isEdit) {
                        this.temp = { ...product };
                        this.previewImage = product.image_url; // ç·¨è¼¯æ™‚å…ˆé¡¯ç¤ºèˆŠåœ–
                    } else {
                        this.temp = { current_stock: 0, safe_stock: 10, lead_time: 2 };
                        this.previewImage = null;
                    }
                    
                    // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥æ¡†çš„å€¼ (é¿å…é¸åŒä¸€å€‹æª”æ¡ˆæ²’åæ‡‰)
                    const fileInput = document.querySelector('input[type="file"]');
                    if(fileInput) fileInput.value = '';
                    
                    this.modal.show();
                },
                // ğŸ”¥ ç•¶ä½¿ç”¨è€…é¸æª”æ¡ˆæ™‚è§¸ç™¼
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.selectedFile = file;
                        // ç”¢ç”Ÿæœ¬æ©Ÿé è¦½ç¶²å€
                        this.previewImage = URL.createObjectURL(file);
                    }
                },
                saveProduct() {
                    // ğŸ”¥ å»ºç«‹ FormData ç‰©ä»¶ (é€™æ˜¯ä¸Šå‚³æª”æ¡ˆçš„é—œéµ)
                    let formData = new FormData();
                    formData.append('name', this.temp.name || '');
                    formData.append('category', this.temp.category || '');
                    formData.append('price', this.temp.price || 0);
                    formData.append('safe_stock', this.temp.safe_stock || 10);
                    formData.append('lead_time', this.temp.lead_time || 2);
                    
                    // å¦‚æœæœ‰é¸æ–°æª”æ¡ˆï¼Œå°±æ”¾æª”æ¡ˆï¼›æ²’æœ‰çš„è©±ï¼ŒæŠŠèˆŠç¶²å€å‚³å›å»
                    if (this.selectedFile) {
                        formData.append('image_file', this.selectedFile);
                    } else {
                        formData.append('image_url', this.temp.image_url || '');
                    }

                    if (this.isEdit) {
                        // ç·¨è¼¯ (PUT)
                        formData.append('current_stock', this.temp.current_stock);
                        axios.put(`/api/products/${this.temp.id}`, formData)
                            .then(() => { this.modal.hide(); this.fetchProducts(); })
                            .catch(err => alert("æ›´æ–°å¤±æ•—: " + err.message));
                    } else {
                        // æ–°å¢ (POST)
                        formData.append('current_stock', this.temp.current_stock || 0);
                        axios.post('/api/products', formData)
                            .then(() => { this.modal.hide(); this.fetchProducts(); })
                            .catch(err => alert("æ–°å¢å¤±æ•—: " + err.message));
                    }
                },
                deleteProduct(id) {
                    if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
                    axios.delete(`/api/products/${id}`)
                        .then(() => this.fetchProducts())
                        .catch(err => {
                            if (err.response && err.response.data && err.response.data.message) {
                                alert("âŒ åˆªé™¤å¤±æ•—ï¼š\n" + err.response.data.message);
                            } else {
                                alert("åˆªé™¤å¤±æ•—");
                            }
                        });
                }
            }
        }).mount('#app')
    </script>
</body>

</html>