<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>å•†å“ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-light">

    {% raw %}
    <div id="app" class="container py-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-secondary">â¬…ï¸ å›é¦–é </a>
                <h2 class="m-0">ğŸ“¦ å•†å“ç®¡ç†</h2>
            </div>
            <button class="btn btn-primary" @click="openModal('add')">ï¼‹ æ–°å¢å•†å“</button>
        </div>

        <table class="table table-hover bg-white shadow-sm rounded align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>åœ–ç‰‡</th>
                    <th>å“å</th>
                    <th>åˆ†é¡</th>
                    <th>åº«å­˜</th>
                    <th>åƒ¹æ ¼</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="p in products" :key="p.id">
                    <td>[[ p.id ]]</td>
                    <td>
                        <img :src="p.image_url" v-if="p.image_url" style="width: 40px; height: 40px; object-fit: cover;"
                            class="rounded">
                        <span v-else class="text-muted small">ç„¡</span>
                    </td>
                    <td class="fw-bold">[[ p.name ]]</td>
                    <td><span class="badge bg-secondary">[[ p.category ]]</span></td>

                    <td :class="{'text-danger fw-bold': p.current_stock < p.safe_stock}">
                        [[ p.current_stock ]]
                    </td>

                    <td>$[[ p.price ]]</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" @click="openModal('edit', p)">ç·¨è¼¯</button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteProduct(p.id)">åˆªé™¤</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="modal fade" id="productModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">[[ isEdit ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“' ]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            <label>å“å</label>
                            <input v-model="temp.name" class="form-control">
                        </div>
                        <div class="row mb-2">
                            <div class="col"><label>åˆ†é¡</label><input v-model="temp.category" class="form-control"></div>
                            <div class="col"><label>åƒ¹æ ¼</label><input v-model.number="temp.price" type="number"
                                    class="form-control"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col"><label>åŸºæœ¬ä¿åº•åº«å­˜</label><input v-model.number="temp.safe_stock" type="number"
                                    class="form-control"></div>
                            <div class="col"><label>è£œè²¨å¤©æ•¸</label><input v-model.number="temp.lead_time" type="number"
                                    class="form-control"></div>
                        </div>
                        <div class="mb-2">
                            <label>åœ–ç‰‡ç¶²å€</label>
                            <input v-model="temp.image_url" class="form-control" placeholder="http://...">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary w-100" @click="saveProduct">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const { createApp } = Vue
        createApp({
            delimiters: ['[[', ']]'],
            data() { return { products: [], temp: {}, modal: null, isEdit: false } },
            mounted() {
                this.modal = new bootstrap.Modal(document.getElementById('productModal'));
                this.fetchProducts();
            },
            methods: {
                fetchProducts() {
                    axios.get('/api/products').then(res => this.products = res.data);
                },
                openModal(type, product) {
                    this.isEdit = (type === 'edit');
                    if (this.isEdit) {
                        this.temp = { ...product }; // è¤‡è£½ä¸€ä»½ï¼Œé¿å…æ”¹åˆ°ä¸€åŠå½±éŸ¿åˆ—è¡¨
                    } else {
                        this.temp = { current_stock: 0, safe_stock: 10, lead_time: 2 }; // é è¨­å€¼
                    }
                    this.modal.show();
                },
                saveProduct() {
                    if (this.isEdit) {
                        // ç·¨è¼¯æ¨¡å¼ (PUT)
                        axios.put(`/api/products/${this.temp.id}`, this.temp)
                            .then(() => { this.modal.hide(); this.fetchProducts(); })
                            .catch(err => alert("æ›´æ–°å¤±æ•—: " + err.message));
                    } else {
                        // æ–°å¢æ¨¡å¼ (POST)
                        axios.post('/api/products', this.temp)
                            .then(() => { this.modal.hide(); this.fetchProducts(); })
                            .catch(err => alert("æ–°å¢å¤±æ•—: " + err.message));
                    }
                },
                deleteProduct(id) {
                    if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;

                    axios.delete(`/api/products/${id}`)
                        .then(() => this.fetchProducts())
                        .catch(err => {
                            // 3. é¡¯ç¤ºå¾Œç«¯å‚³å›ä¾†çš„éŒ¯èª¤è¨Šæ¯ (ä¾‹å¦‚ï¼šå·²è³£éä¸èƒ½åˆª)
                            if (err.response && err.response.data && err.response.data.message) {
                                alert("âŒ åˆªé™¤å¤±æ•—ï¼š\n" + err.response.data.message);
                            } else {
                                alert("åˆªé™¤å¤±æ•—");
                            }
                        });
                }
            }
        }).mount('#app')
    </script>
</body>

</html>