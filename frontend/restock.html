<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>é€²è²¨ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-light">

    {% raw %}
    <div id="app" class="container py-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-secondary">â¬…ï¸ å›é¦–é </a>
                <h2 class="m-0">ğŸšš é€²è²¨ç®¡ç†</h2>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-5">
                <div class="card p-3 shadow-sm border-0 mb-4">
                    <h5 class="card-title fw-bold mb-3 text-success">1. æ‰‹å‹•æ–°å¢</h5>

                    <div class="mb-3">
                        <label>é¸æ“‡å•†å“</label>
                        <select class="form-select" v-model="selected">
                            <option :value="null">è«‹é¸æ“‡...</option>
                            <option v-for="p in products" :value="p">
                                [[ p.name ]] (ç¾æœ‰: [[ p.current_stock ]])
                            </option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>æ•¸é‡</label>
                        <input type="number" class="form-control" v-model.number="qty" min="1">
                    </div>
                    <button class="btn btn-outline-success w-100" @click="addToList(selected, qty)"
                        :disabled="!selected || qty <= 0">
                        â¬‡ï¸ åŠ å…¥æ¸…å–®
                    </button>
                </div>

                <div class="card p-3 shadow-sm border-0 border-start border-4 border-danger"
                    v-if="urgentList.length > 0">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="card-title fw-bold text-danger m-0">ğŸš¨ æ€¥éœ€è£œè²¨å»ºè­°</h5>
                        <span class="badge bg-danger">[[ urgentList.length ]] é …</span>
                    </div>
                    <p class="text-muted small">ç³»çµ±åµæ¸¬åˆ°ä»¥ä¸‹å•†å“ä½æ–¼å®‰å…¨æ°´ä½</p>

                    <div class="list-group list-group-flush">
                        <button
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                            v-for="item in urgentList" :key="item.id" @click="quickAdd(item)">

                            <div>
                                <strong>[[ item.name ]]</strong>
                                <div class="small text-muted">
                                    åº«å­˜: [[ item.current_stock ]] | [[ item.status_text ]]
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-secondary mb-1">å»ºè­° +[[ parseSuggestion(item.suggestion) ]]</span>
                                <br>
                                <small class="text-primary">é»æ“Šå¸¶å…¥ â•</small>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="card p-3 shadow-sm border-0 mb-4" v-if="list.length > 0">
                    <h5 class="fw-bold text-dark border-bottom pb-2">ğŸ“¦ æº–å‚™é€²è²¨æ¸…å–®</h5>
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            v-for="(item, i) in list" :key="i">
                            <span>[[ item.name ]]</span>
                            <span class="fw-bold text-success">+[[ item.quantity ]]</span>
                            <button class="btn btn-sm btn-link text-danger text-decoration-none"
                                @click="list.splice(i,1)">âœ•</button>
                        </li>
                    </ul>
                    <button class="btn btn-success w-100 py-2" @click="submit">
                        âœ… ç¢ºèªé€²è²¨ (å¯«å…¥åº«å­˜)
                    </button>
                </div>

                <div class="card p-3 shadow-sm border-0">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title fw-bold m-0 text-dark">ğŸ“œ é€²è²¨æ­·å²ç´€éŒ„</h5>
                        <button class="btn btn-sm btn-outline-secondary" @click="fetchHistory">ğŸ”„</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>å–®è™Ÿ</th>
                                    <th>æ™‚é–“</th>
                                    <th>å…§å®¹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="order in history" :key="order.id">
                                    <td>#[[ order.id ]]</td>
                                    <td class="small text-muted">[[ formatDate(order.created_at) ]]</td>
                                    <td class="small">[[ order.details ]]</td>
                                    <td><button class="btn btn-sm btn-outline-danger"
                                            @click="deleteOrder(order.id)">ä½œå»¢</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue
        createApp({
            delimiters: ['[[', ']]'],
            data() { return { products: [], selected: null, qty: 10, list: [], history: [], urgentList: [] } },
            mounted() {
                this.fetchProducts();
                this.fetchHistory();
                this.fetchUrgent(); // è¼‰å…¥æ™‚é †ä¾¿æŠ“ç´…ç‡ˆè³‡æ–™
            },
            methods: {
                fetchProducts() { axios.get('/api/products').then(res => this.products = res.data); },
                fetchHistory() { axios.get('/api/restock/orders').then(res => this.history = res.data); },

                // æŠ“å–ç´…ç‡ˆè³‡æ–™ (ç”¨ä¾†é¡¯ç¤ºåœ¨å·¦ä¸‹è§’)
                fetchUrgent() {
                    axios.get('/api/inventory/alerts').then(res => {
                        this.urgentList = res.data.red_lights;
                    });
                },

                addToList(product, quantity) {
                    if (product && quantity > 0) {
                        // æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨æ¸…å–®è£¡ï¼Œæœ‰çš„è©±å°±ç´¯åŠ 
                        let existing = this.list.find(i => i.product_id === product.id);
                        if (existing) {
                            existing.quantity += parseInt(quantity);
                        } else {
                            this.list.push({ product_id: product.id, name: product.name, quantity: parseInt(quantity) });
                        }
                        this.selected = null;
                        this.qty = 10;
                    }
                },

                // é»æ“Šç´…ç‡ˆå¡ç‰‡å¿«é€Ÿå¸¶å…¥
                quickAdd(item) {
                    // å¾å¾Œç«¯å›å‚³çš„å­—ä¸² "å»ºè­°è£œè²¨ 15 å€‹" è§£æå‡ºæ•¸å­— 15
                    let suggestQty = this.parseSuggestion(item.suggestion);
                    this.addToList(item, suggestQty);
                },

                // è§£æå»ºè­°å­—ä¸²æ‹¿åˆ°æ•¸å­—
                parseSuggestion(str) {
                    let match = str.match(/\d+/);
                    return match ? parseInt(match[0]) : 10;
                },

                submit() {
                    if (!confirm("ç¢ºå®šå¯«å…¥åº«å­˜å—ï¼Ÿ")) return;
                    axios.post('/api/restock', { items: this.list }).then(() => {
                        alert('ğŸ‰ é€²è²¨æˆåŠŸï¼');
                        this.list = [];
                        this.fetchProducts();
                        this.fetchHistory();
                        this.fetchUrgent(); // é€²è²¨å®Œé‡æ–°æª¢æŸ¥ç´…ç‡ˆ
                    }).catch(err => alert("å¤±æ•—: " + err.message));
                },
                deleteOrder(id) {
                    if (!confirm(`ç¢ºå®šä½œå»¢å–®è™Ÿ #${id} å—ï¼Ÿåº«å­˜å°‡æ‰£å›ï¼`)) return;
                    axios.delete(`/api/restock/orders/${id}`).then(() => {
                        alert("å·²ä½œå»¢ã€‚");
                        this.fetchProducts();
                        this.fetchHistory();
                        this.fetchUrgent();
                    });
                },
                formatDate(str) {
                    return str ? new Date(str).toLocaleString('zh-TW', { hour12: false }) : '';
                }
            }
        }).mount('#app')
    </script>
</body>

</html>