<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>éŠ·å”®ç´€éŒ„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-light">

    {% raw %}
    <div id="app" class="container py-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-secondary">â¬…ï¸ å›é¦–é </a>
                <h2 class="m-0">ğŸ’° éŠ·å”®ç´€éŒ„ (å¸³æœ¬)</h2>
            </div>
            
            <div class="text-end">
                <div class="small text-muted">[[ dateRangeText ]]</div>
                <div class="h4 m-0 text-success fw-bold">
                    ç‡Ÿæ”¶: $[[ totalRevenue ]]
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-3 p-3">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <label class="fw-bold">ğŸ“… ç¯©é¸å€é–“ï¼š</label>
                
                <input type="date" class="form-control w-auto" v-model="startDate" title="èµ·å§‹æ—¥æœŸ">
                <span>ï½</span>
                <input type="date" class="form-control w-auto" v-model="endDate" title="çµæŸæ—¥æœŸ">

                <button class="btn btn-outline-secondary btn-sm ms-2" 
                    @click="clearFilter" 
                    v-if="startDate || endDate">
                    æ¸…é™¤ç¯©é¸
                </button>
                
                <button class="btn btn-outline-primary btn-sm ms-auto" @click="setToday">ä»Šå¤©</button>
                <button class="btn btn-outline-primary btn-sm" @click="setThisMonth">é€™å€‹æœˆ</button>
            </div>
        </div>

        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">å–®è™Ÿ</th>
                            <th>æ™‚é–“</th>
                            <th>é¡§å®¢é¡å‹</th>
                            <th>è³¼è²·å…§å®¹</th>
                            <th>ç¸½é‡‘é¡</th>
                            <th class="text-end pe-4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="order in filteredOrders" :key="order.id">
                            <td class="ps-4 text-muted">#[[ order.id ]]</td>
                            <td class="small">[[ formatDate(order.created_at) ]]</td>
                            <td>
                                <span class="badge" :class="getBadgeClass(order.customer_type)">
                                    [[ translateType(order.customer_type) ]]
                                </span>
                            </td>
                            <td class="text-truncate" style="max-width: 300px;">[[ order.details ]]</td>
                            <td class="fw-bold text-success">$[[ order.total_price ]]</td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-danger" @click="refund(order.id)">ä½œå»¢/é€€æ¬¾</button>
                            </td>
                        </tr>
                        <tr v-if="filteredOrders.length === 0">
                            <td colspan="6" class="text-center py-5 text-muted">
                                <div class="fs-1 mb-2">ğŸ”</div>
                                [[ (startDate || endDate) ? 'é€™å€‹å€é–“æ²’æœ‰éŠ·å”®ç´€éŒ„å–”' : 'ç›®å‰æ²’æœ‰éŠ·å”®ç´€éŒ„' ]]
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue
        createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    orders: [],
                    startDate: '', // èµ·å§‹æ—¥
                    endDate: ''    // çµæŸæ—¥
                }
            },
            computed: {
                // ğŸ”¥ æ ¸å¿ƒé‚è¼¯ï¼šç¯„åœéæ¿¾
                filteredOrders() {
                    // å¦‚æœéƒ½æ²’é¸ï¼Œå›å‚³å…¨éƒ¨
                    if (!this.startDate && !this.endDate) {
                        return this.orders;
                    }

                    return this.orders.filter(order => {
                        // 1. æŠŠè¨‚å–®æ™‚é–“è½‰æˆ YYYY-MM-DD å­—ä¸²æ–¹ä¾¿æ¯”å°
                        const orderDate = new Date(order.created_at);
                        const yyyy = orderDate.getFullYear();
                        const mm = String(orderDate.getMonth() + 1).padStart(2, '0');
                        const dd = String(orderDate.getDate()).padStart(2, '0');
                        const orderDateStr = `${yyyy}-${mm}-${dd}`;
                        
                        // 2. æ¯”å°é‚è¼¯
                        let passStart = true;
                        let passEnd = true;

                        if (this.startDate) {
                            passStart = (orderDateStr >= this.startDate);
                        }
                        if (this.endDate) {
                            passEnd = (orderDateStr <= this.endDate);
                        }

                        return passStart && passEnd;
                    });
                },
                totalRevenue() {
                    return this.filteredOrders.reduce((sum, order) => sum + order.total_price, 0);
                },
                dateRangeText() {
                    if (this.startDate && this.endDate) {
                        return `${this.startDate} ~ ${this.endDate}`;
                    } else if (this.startDate) {
                        return `${this.startDate} ä¹‹å¾Œ`;
                    } else if (this.endDate) {
                        return `${this.endDate} ä¹‹å‰`;
                    }
                    return 'ç¸½ç´¯ç©ç´€éŒ„';
                }
            },
            mounted() {
                this.fetchHistory();
            },
            methods: {
                fetchHistory() {
                    axios.get('/api/sales/history').then(res => {
                        this.orders = res.data;
                    });
                },
                clearFilter() {
                    this.startDate = '';
                    this.endDate = '';
                },
                // ğŸ”¥ å¿«é€Ÿè¨­å®šï¼šä»Šå¤©
                setToday() {
                    const today = new Date();
                    const str = this.toISODate(today);
                    this.startDate = str;
                    this.endDate = str;
                },
                // ğŸ”¥ å¿«é€Ÿè¨­å®šï¼šé€™å€‹æœˆ (æœˆåˆåˆ°ä»Šå¤©)
                setThisMonth() {
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    this.startDate = this.toISODate(firstDay);
                    this.endDate = this.toISODate(today);
                },
                // è¼”åŠ©å‡½å¼ï¼šè½‰æˆ YYYY-MM-DD
                toISODate(dateObj) {
                    const yyyy = dateObj.getFullYear();
                    const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const dd = String(dateObj.getDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                },
                refund(id) {
                    if (!confirm(`ç¢ºå®šè¦ä½œå»¢è¨‚å–® #${id} å—ï¼Ÿ\nâš ï¸ éŒ¢æœƒæ‰£æ‰ï¼Œå•†å“åº«å­˜æœƒåŠ å›å»ï¼`)) return;
                    axios.delete(`/api/sales/orders/${id}`)
                        .then(() => {
                            alert("å·²ä½œå»¢æˆåŠŸï¼");
                            this.fetchHistory();
                        })
                        .catch(err => alert("å¤±æ•—: " + err.message));
                },
                formatDate(str) {
                    return str ? new Date(str).toLocaleString('zh-TW', { hour12: false }) : '';
                },
                translateType(type) {
                    const map = {
                        'Under 20': 'å­¸ç”Ÿ (20æ­²ä»¥ä¸‹)',
                        '20-40': 'é’å£¯å¹´ (20-40æ­²)',
                        '40-60': 'ä¸­å¹´ (40-60æ­²)',
                        'Over 60': 'éŠ€é«®æ— (60æ­²ä»¥ä¸Š)',
                        'General': 'ä¸€èˆ¬'
                    };
                    return map[type] || type || 'ä¸€èˆ¬';
                },
                getBadgeClass(type) {
                    if (type === 'Under 20') return 'bg-info text-dark'; 
                    if (type === '20-40') return 'bg-success';
                    if (type === '40-60') return 'bg-warning text-dark';
                    if (type === 'Over 60') return 'bg-secondary';
                    return 'bg-secondary';
                }
            }
        }).mount('#app')
    </script>
</body>

</html>