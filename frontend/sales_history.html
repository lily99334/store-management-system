<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>éŠ·å”®ç´€éŒ„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-light">

    {% raw %}
    <div id="app" class="container py-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-secondary">â¬…ï¸ å›é¦–é </a>
                <h2 class="m-0">ğŸ’° éŠ·å”®ç´€éŒ„ (å¸³æœ¬)</h2>
            </div>
            <div class="h5 m-0 text-success">
                ä»Šæ—¥ç¸½ç‡Ÿæ”¶: $[[ totalRevenue ]]
            </div>
        </div>

        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">å–®è™Ÿ</th>
                            <th>æ™‚é–“</th>
                            <th>é¡§å®¢é¡å‹</th>
                            <th>è³¼è²·å…§å®¹</th>
                            <th>ç¸½é‡‘é¡</th>
                            <th class="text-end pe-4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="order in orders" :key="order.id">
                            <td class="ps-4 text-muted">#[[ order.id ]]</td>
                            <td class="small">[[ formatDate(order.created_at) ]]</td>
                            <td>
                                <span class="badge"
                                    :class="order.customer_type === 'Student' ? 'bg-info' : 'bg-secondary'">
                                    [[ order.customer_type === 'Student' ? 'å­¸ç”Ÿ' : 'ä¸€èˆ¬' ]]
                                </span>
                            </td>
                            <td class="text-truncate" style="max-width: 300px;">[[ order.details ]]</td>
                            <td class="fw-bold text-success">$[[ order.total_price ]]</td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-danger" @click="refund(order.id)">ä½œå»¢/é€€æ¬¾</button>
                            </td>
                        </tr>
                        <tr v-if="orders.length === 0">
                            <td colspan="6" class="text-center py-5 text-muted">ç›®å‰æ²’æœ‰éŠ·å”®ç´€éŒ„</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue
        createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    orders: []
                }
            },
            computed: {
                totalRevenue() {
                    // ç°¡å–®è¨ˆç®—ç•«é¢ä¸Šçš„ç¸½é‡‘é¡
                    return this.orders.reduce((sum, order) => sum + order.total_price, 0);
                }
            },
            mounted() {
                this.fetchHistory();
            },
            methods: {
                fetchHistory() {
                    axios.get('/api/sales/history').then(res => {
                        this.orders = res.data;
                    });
                },
                refund(id) {
                    if (!confirm(`ç¢ºå®šè¦ä½œå»¢è¨‚å–® #${id} å—ï¼Ÿ\nâš ï¸ éŒ¢æœƒæ‰£æ‰ï¼Œå•†å“åº«å­˜æœƒåŠ å›å»ï¼`)) return;

                    axios.delete(`/api/sales/orders/${id}`)
                        .then(() => {
                            alert("å·²ä½œå»¢æˆåŠŸï¼");
                            this.fetchHistory();
                        })
                        .catch(err => alert("å¤±æ•—: " + err.message));
                },
                formatDate(str) {
                    return str ? new Date(str).toLocaleString('zh-TW', { hour12: false }) : '';
                }
            }
        }).mount('#app')
    </script>
</body>

</html>