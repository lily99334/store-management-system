<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰å°æ”¶éŠ€ç³»çµ± (POS)</title>
    
    <!-- 1. å¼•å…¥ Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- è‡ªè¨‚ CSS å€åŸŸ -->
    <style>
        /* --- ğŸª å°ä¸ƒé…è‰²è®Šæ•¸å®šç¾© --- */
        :root {
            --seven-green: #008162;  /* æ‹›ç‰Œç¶  */
            --seven-orange: #F58320; /* æ´»åŠ›æ©˜ */
            --seven-red: #EE2E24;    /* è­¦ç¤ºç´… */
        }

        /* --- è‡ªè¨‚å°ä¸ƒå·¥å…·é¡åˆ¥ --- */
        .text-seven-green { color: var(--seven-green) !important; }
        .text-seven-orange { color: var(--seven-orange) !important; }
        .bg-seven-green { background-color: var(--seven-green) !important; }
        .bg-seven-orange { background-color: var(--seven-orange) !important; }

        /* ç¶ è‰²æŒ‰éˆ• (ç”¨æ–¼çµå¸³ã€ä¸»è¦æ“ä½œ) */
        .btn-seven-green {
            background-color: var(--seven-green);
            border-color: var(--seven-green);
            color: white;
        }
        .btn-seven-green:hover {
            background-color: #00634a; /* æ·±ä¸€é»çš„ç¶  */
            color: white;
        }

        /* æ©˜è‰²æŒ‰éˆ• (ç”¨æ–¼åŠ å…¥ã€æ¬¡è¦æ“ä½œ) */
        .btn-seven-orange {
            background-color: var(--seven-orange);
            border-color: var(--seven-orange);
            color: white;
        }
        .btn-seven-orange:hover {
            background-color: #d96e11; /* æ·±ä¸€é»çš„æ©˜ */
            color: white;
        }

        /* --- å…¨åŸŸè¨­å®š --- */
        body {
            background-color: #f4f6f9; /* æ•´é«”èƒŒæ™¯è‰² */
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢æ•´å€‹é é¢æ²å‹• */
        }

        /* --- å·¦å´ï¼šå•†å“ç‰†èˆ‡è¼¸å…¥å€å®¹å™¨ --- */
        .left-panel {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- å•†å“ç‰†æ¨£å¼ --- */
        .product-section {
            flex-grow: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
            overflow-y: auto; /* è®“å•†å“å¤šæ™‚å¯ä»¥æ²å‹• */
            padding: 20px;
            /* èƒŒæ™¯ç¨å¾®å¸¶ä¸€é»é»æ©˜è‰²èª¿çš„ç°ï¼Œæ¯”è¼ƒæº«æš– */
            background-color: #fffaf5;
        }

        /* --- åº•éƒ¨è¼¸å…¥å€æ¨£å¼ --- */
        .input-section {
            background-color: white;
            padding: 20px;
            border-top: 4px solid var(--seven-orange); /* é ‚éƒ¨åŠ ä¸€æ¢æ©˜è‰²ç·šæ¢è£é£¾ */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .product-card {
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #eee; /* åŠ ä¸Šæ·¡æ·¡é‚Šæ¡† */
            border-radius: 15px; /* åœ“è§’ */
            background: white;
            height: 120px !important; 
            min-height: 120px !important;
            max-height: 120px !important;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px); /* æ»‘é¼ ç§»éå»æµ®èµ·ä¾† */
            box-shadow: 0 10px 20px rgba(0,129,98,0.15); /* é™°å½±æ”¹æˆç¶ è‰²èª¿ */
            border: 2px solid var(--seven-green); /* é¸ä¸­æ™‚çš„æ¡†ç·šé¡è‰² */
        }
        .product-card:active { transform: scale(0.98); }

        .product-price {
            color: var(--seven-red); /* åƒ¹æ ¼ç”¨å°ä¸ƒç´… */
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* --- å³å´ï¼šè³¼ç‰©è»Šæ¨£å¼ --- */
        .cart-section {
            height: 100vh;
            background-color: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
        }

        .cart-header {
            /* æ”¹æˆæ‹›ç‰Œç¶ èƒŒæ™¯ */
            background-color: var(--seven-green);
            /* background-color: #212529; è³¼ç‰©è»Šæ¨™é¡ŒèƒŒæ™¯ (é»‘) */
            color: white;
            padding: 15px;
            /* åŠ ä¸Šæ©˜è‰²æ¢ç´‹è£é£¾ (æ¨¡æ“¬åˆ¶æœ/Logo) */
            border-bottom: 5px solid var(--seven-orange);
        }

        .cart-list {
            flex-grow: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
            overflow-y: auto; /* è³¼ç‰©è»Šå¤ªé•·æ™‚å¯æ²å‹• */
            padding: 10px;
        }

        .cart-footer {
            background-color: #f8f9fa;
            padding: 20px;
            border-top: 2px solid #dee2e6;
        }

        /* çµå¸³æŒ‰éˆ•ç‰¹æ•ˆ */
        .btn-checkout {
            height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

       /* é‡å°å°è¢å¹•å„ªåŒ– */
        @media (max-width: 1000px) {
            
            .left-panel {
                width: 55% !important; 
            }
            .cart-section {
                width: 45% !important;
            }

            /* ç¸®å°æ•´é«”å­—é«” */
            body {
                font-size: 0.9rem;
            }
            
            /* å•†å“ç‰†æ”¹ç‚ºä¸€åˆ—é¡¯ç¤º 2 å€‹ */
            .product-section .col-lg-3 {
                width: 50%; 
            }
            
            /* å­—é«”ç¨å¾®ç¸®å°ä¸€é»é»ï¼Œé¿å…çˆ†ç‰ˆ */
            .product-price { font-size: 1rem; }
            .card-title { font-size: 1rem; margin-bottom: 0.2rem !important; }

            /* éš±è—éƒ¨åˆ†éå¿…è¦è³‡è¨Šä»¥ç¯€çœç©ºé–“ */
            .input-section .form-label {
                display: none; /* éš±è—ã€Œæ‰‹å‹•è¼¸å…¥...ã€é‚£è¡Œæ–‡å­— */
            }

            /* èª¿æ•´çµå¸³æŒ‰éˆ•é«˜åº¦ */
            .btn-checkout {
                height: 50px;
                font-size: 1.2rem;
            }
            
            .display-5 {
                font-size: 1.5rem; /* ç¸½é‡‘é¡æ•¸å­—ç¸®å° */
            }
        }
        /* --- è³‡æ–™å¤¾åˆ†é æ¨£å¼ --- */
        .folder-tabs-container {
            /* åº•éƒ¨åŠ ä¸€æ¢ç·šï¼Œè®“æ¨™ç±¤çœ‹èµ·ä¾†æ˜¯é»åœ¨ä¸Šé¢çš„ */
            border-bottom: 2px solid var(--seven-green);
            padding-left: 10px; /* å·¦é‚Šç•™ä¸€é»ç©ºéš™ */
        }

        .folder-tab {
            border: 1px solid #ddd; /* é è¨­ç°è‰²é‚Šæ¡† */
            border-bottom: none; /* åº•éƒ¨ä¸è¦é‚Šæ¡†ï¼Œæ‰èƒ½è·Ÿä¸‹é¢çš„ç·šé€£åœ¨ä¸€èµ· */
            background-color: #f8f9fa; /* é è¨­æ·ºç°èƒŒæ™¯ */
            color: #6c757d; /* é è¨­æ·±ç°æ–‡å­— */
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 10px 10px 0 0; /* åªæœ‰ä¸Šé¢å…©å€‹è§’æ˜¯åœ“çš„ */
            margin-right: 5px; /* æ¨™ç±¤ä¹‹é–“ç•™é»ç©ºéš™ */
            transition: all 0.2s; /* è®“åˆ‡æ›æ™‚æœ‰æ»‘é †æ•ˆæœ */
            position: relative;
            top: 2px; /* ç¨å¾®å¾€ä¸‹å£“ä¸€é»ï¼Œè“‹ä½åº•ç·š */
        }

        /* æ»‘é¼ ç§»ä¸Šå»çš„æ•ˆæœ */
        .folder-tab:hover {
            background-color: #e9ecef;
            color: var(--seven-green);
        }

        /* è¢«é¸ä¸­æ™‚çš„æ¨£å¼ (é—œéµ!) */
        .folder-tab.active {
            background-color:var(--seven-green); /* èƒŒæ™¯è®Šç¶ è‰² */
            color:white; /* æ–‡å­—è®Šç™½è‰² */
            border-color: var(--seven-green); /* é‚Šæ¡†è®Šç¶ è‰² */
            border-bottom: 2px solid var(--seven-green); /* åº•éƒ¨é‚Šæ¡†ä¹Ÿè®Šç¶ è‰² */
            z-index: 1; /* è®“å®ƒæµ®åœ¨æœ€ä¸Šé¢ */
        }

        /* æ¨¡æ“¬å°ä¸ƒçš„æ¢ç´‹æ²è»¸ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--seven-green); }
    
    </style>
</head>
<body>
{% raw %}

<div id="app" class="container-fluid p-0">
    <div class="row g-0"> <!-- g-0 ä»£è¡¨ç§»é™¤æ¬„ä½é–“è· -->
        
        <!-- ========================== -->
        <!-- ğŸŸ¢ å·¦å´ï¼šå•†å“ç‰† + åº•éƒ¨è¼¸å…¥å€ -->
        <!-- ========================== -->
        <div class="col-7 col-md-8 left-panel">
            
            <!-- ä¸ŠåŠéƒ¨ï¼šå•†å“ç‰† (å¯æ²å‹•) -->
            <div class="product-section">
                <!-- æ¨™é¡Œ -->
                <div class="d-flex align-items-center mb-4">
                    <!-- å›é¦–é æŒ‰éˆ• -->
                        <a href="/" class="btn btn-outline-secondary btn-sm rounded-circle border-2 me-3" 
                           style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-house-fill"></i>
                        </a>
                        <!-- <a href="/" class="btn btn-outline-secondary btn-sm rounded-pill border-2 me-3 px-3 fw-bold" 
                        style="height: 40px; display: flex; align-items: center; justify-content: center; text-decoration: none;">
                            <i class="bi bi-chevron-left me-1"></i>
                        å›é¦–é 
                        </a> -->
                    <!-- æ¨™é¡Œ -->
                    <h3 class="fw-bold text-seven-green m-0">
                        <span class="fs-2">ğŸª</span> å•†å“é¸æ“‡
                    </h3>
                </div>
                <div class="d-flex overflow-auto folder-tabs-container" style="white-space: nowrap;">
                    <button v-for="cat in categoryList" 
                        key="cat"
                        class="btn folder-tab"
                        :class="{ 'active': selectedCategory === cat }"
                        @click="selectedCategory = cat">
                        {{ cat }}
                    </button>
                </div>
                
                <!-- å•†å“åˆ—è¡¨ (Vue è¿´åœˆ) -->
                <div class="row g-3">
                    <div class="col-6 col-md-4 col-lg-3" v-for="product in filteredProducts" :key="product.id">
                        <!-- @click="addToCart" æ˜¯æ ¸å¿ƒäº’å‹•ï¼Œä¸è¦åˆª -->
                        <div class="card product-card h-100 overflow-hidden border-0 shadow-sm" @click="addToCart(product)">
                            <div class="row g-0 h-100">
                                
                                <div class="col-4 bg-light d-flex align-items-center justify-content-center p-0 h-100">
                                    <img :src="product.image_url"
                                        class="img-fluid" 
                                        style="width: 100%; height: 100%; object-fit: cover;" 
                                        alt="å•†å“åœ–">
                                </div>
                                
                                <div class="col-8 h-100">
                                    <div class="card-body p-2 d-flex flex-column justify-content-center h-100">
                                        
                                        <small class="text-muted fw-bold" style="font-size: 0.7rem;">
                                            ID: {{ product.id }}
                                        </small>
                                        <h6 class="card-title fw-bold text-dark mb-1 text-truncate" style="font-size: 0.95rem;">
                                            {{ product.name }}
                                        </h6>
                                        
                                        <div class="mb-1">
                                            <span class="badge bg-secondary opacity-75" style="font-size: 0.8rem;">{{ product.category }}</span>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-end mt-auto">
                                            <span class="text-danger fw-bold">${{ product.price }}</span>
                                            
                                            <small v-if="product.current_stock <= 0" class="text-danger fw-bold" style="font-size: 0.8rem;">
                                                âš ï¸è£œè²¨
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <label class="form-label fw-bold text-muted mb-2">è¼¸å…¥å•†å“ç·¨è™Ÿ</label>
                <div class="input-group input-group-lg">
                    <input type="text" 
                            class="form-control" 
                            placeholder="è«‹è¼¸å…¥å•†å“ ID (å¦‚: 1001)..."
                            v-model="inputProductId"
                            @keyup.enter="addProductById">
                            
                    <button class="btn btn-seven-orange fw-bold px-4" @click="addProductById">åŠ å…¥è³¼ç‰©è»Š</button>
                </div>
            </div>
        </div>

        <!-- ========================== -->
        <!-- ğŸ›’ å³å´ï¼šè³¼ç‰©è»Š (ä½” 4/12) -->
        <!-- ========================== -->
        <div class="col-5 col-md-4 cart-section">
            
            <!-- æ¨™é¡Œ -->
            <div class="cart-header d-flex justify-content-between align-items-center">
                <h4 class="m-0">ğŸ›’ è³¼ç‰©æ¸…å–®</h4>
                <button class="btn btn-sm btn-outline-light fw-bold" @click="openOrderHistory">
                    ğŸ“‹ äº¤æ˜“ç´€éŒ„
                </button>
                <span class="badge bg-danger rounded-pill">{{ cartTotalCount }} ä»¶</span>
            </div>

            <!-- æ¸…å–®åˆ—è¡¨ -->
            <div class="cart-list">
                <table class="table table-hover align-middle">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>å“å</th>
                            <th class="text-center">æ•¸é‡</th>
                            <th class="text-end">å°è¨ˆ</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- è³¼ç‰©è»Šè¿´åœˆ -->
                        <tr v-for="(item, index) in cart" :key="index">
                            <td class="fw-bold">{{ item.name }}</td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-secondary" @click="decreaseQty(item)">-</button>
                                    <button class="btn btn-light border disabled text-dark fw-bold" style="width: 30px;">{{ item.quantity }}</button>
                                    <button class="btn btn-outline-secondary" @click="item.quantity++">+</button>
                                </div>
                            </td>
                            <td class="text-end fw-bold">${{ item.price * item.quantity }}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-link text-danger text-decoration-none" @click="removeFromCart(index)">âœ•</button>
                            </td>
                        </tr>
                        <!-- è³¼ç‰©è»Šç‚ºç©ºæ™‚é¡¯ç¤º -->
                        <tr v-if="cart.length === 0">
                            <td colspan="4" class="text-center text-muted py-5">
                                <div class="fs-1 mb-2">ğŸ‘»</div>
                                å°šæœªåŠ å…¥ä»»ä½•å•†å“<br>
                                <small>è«‹é»é¸å·¦å´æˆ–ä¸‹æ–¹è¼¸å…¥ç·¨è™Ÿ</small>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- åº•éƒ¨çµå¸³å€ -->
            <div class="cart-footer">
                <div class="d-flex justify-content-between align-items-end mb-3">
                    <span class="text-muted">ç¸½é‡‘é¡ Total</span>
                    <span class="display-5 fw-bold text-danger">${{ totalPrice }}</span>
                </div>
                <div class="d-flex gap-2">
                    <!-- (æ–°å¢) å–æ¶ˆè¨‚å–®æŒ‰éˆ• -->
                    <button class="btn btn-outline-danger w-25 rounded-pill fw-bold" 
                            @click="clearCart" 
                            :disabled="cart.length === 0">
                        å–æ¶ˆ
                    </button>
                    <!-- çµå¸³æŒ‰éˆ• -->
                    <button class="btn btn-seven-green w-75 btn-checkout rounded-pill" 
                            @click="showCheckoutModal" 
                            :disabled="cart.length === 0">
                        çµ å¸³
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================== -->
    <!-- ğŸ’³ çµå¸³å½ˆçª— (Modal) -->
    <!-- ========================== -->
    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold">ğŸ‘¤ è«‹é¸æ“‡é¡§å®¢é¡å‹</h5>
                    <button type="button" class="btn-close btn-close-white" @click="closeModal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-center mb-4 text-muted">è«‹é»é¸å®¢å±¤æ¨™ç±¤ä»¥å®Œæˆäº¤æ˜“ä¸¦æ‰£é™¤åº«å­˜</p>
                    <div class="row g-3">
                        <!-- å®¢å±¤æŒ‰éˆ• (é»ä¸‹å»æœƒè§¸ç™¼ confirmSubmit) -->
                        <div class="col-6"><button class="btn btn-outline-primary w-100 py-3 fs-5 fw-bold" @click="confirmSubmit('å­¸ç”Ÿ')">ğŸ§‘â€ğŸ“ å­¸ç”Ÿ</button></div>
                        <div class="col-6"><button class="btn btn-outline-dark w-100 py-3 fs-5 fw-bold" @click="confirmSubmit('ä¸Šç­æ—')">ğŸ’¼ ä¸Šç­æ—</button></div>
                        <div class="col-6"><button class="btn btn-outline-success w-100 py-3 fs-5 fw-bold" @click="confirmSubmit('å®¶åº­')">ğŸ  å®¶åº­</button></div>
                        <div class="col-6"><button class="btn btn-outline-warning w-100 py-3 fs-5 fw-bold" @click="confirmSubmit('é•·è¼©')">ğŸ‘´ é•·è¼©</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow border-0">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">âœ¨ ç¢ºèªè¨‚å–®è³‡è¨Š</h5>
                    </div>
                <div class="modal-body p-4 text-center">
                    
                    <div class="mb-3 text-muted">å³å°‡ç‚ºä»¥ä¸‹å®¢å±¤çµå¸³</div>
                    
                    <h2 class="fw-bold text-primary mb-4">{{ tempCustomerTag }}</h2>
                    
                    <div class="card bg-light border-0 p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fs-5 text-secondary">ç¸½é‡‘é¡</span>
                            <span class="fs-2 fw-bold text-danger">${{ totalPrice }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="text-secondary">å•†å“ä»¶æ•¸</span>
                            <span class="fw-bold">{{ cartTotalCount }} ä»¶</span>
                        </div>
                    </div>

                    <p class="small text-muted mb-0">è«‹ç¢ºèªé‡‘é¡ç„¡èª¤å¾Œå†é€å‡º</p>
                </div>
                <div class="modal-footer justify-content-center border-0 pb-4">
                    <button type="button" class="btn btn-light btn-lg px-4 fw-bold rounded-pill" @click="closeConfirmModal">
                        è¿”å›ä¿®æ”¹
                    </button>
                    <button type="button" class="btn btn-primary btn-lg px-5 fw-bold rounded-pill shadow" @click="executeFinalSubmit">
                        âœ… ç¢ºèªçµå¸³
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow border-0">
                <div class="modal-body p-5 text-center">
                    
                    <div class="mb-4">
                        <div style="font-size: 5rem;">ğŸ‰</div>
                    </div>

                    <h2 class="fw-bold text-success mb-3">çµå¸³æˆåŠŸï¼</h2>
                    <p class="text-muted mb-4">äº¤æ˜“å·²å®Œæˆ</p>

                    <div class="card bg-light border-0 p-3 mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-secondary">å®¢å±¤</span>
                            <span class="fw-bold">{{ lastOrder.customer }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-secondary">æ”¯ä»˜é‡‘é¡</span>
                            <span class="fw-bold text-danger fs-5">${{ lastOrder.total }}</span>
                        </div>
                    </div>

                    <button type="button" class="btn btn-success btn-lg px-5 rounded-pill shadow w-100" @click="closeSuccessModal">
                        ä¸‹ä¸€ä½é¡§å®¢
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="clearCartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow border-0">
                <div class="modal-body p-4 text-center">

                    <div class="mb-3 text-danger">
                        <div style="font-size: 4rem;">ğŸ—‘ï¸</div>
                    </div>
                    <h3 class="fw-bold text-danger mb-3">ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šï¼Ÿ</h3>
                    <p class="text-muted mb-4">é€™å°‡æœƒç§»é™¤ç›®å‰æ¸…å–®ä¸­çš„æ‰€æœ‰å•†å“ï¼Œ<br>æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>

                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-light btn-lg px-4 fw-bold rounded-pill" @click="closeClearCartModal">
                            å–æ¶ˆ
                        </button>
                        <button type="button" class="btn btn-danger btn-lg px-4 fw-bold rounded-pill shadow" @click="executeClearCart">
                            ç¢ºèªæ¸…ç©º
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="removeItemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow border-0">
                <div class="modal-body p-4 text-center">
                    
                    <div class="mb-3 text-warning">
                        <div style="font-size: 4rem;">âš ï¸</div>
                    </div>

                    <h4 class="fw-bold mb-3">ç§»é™¤å•†å“ï¼Ÿ</h4>
                    
                    <p class="text-muted mb-4">
                        ç¢ºå®šè¦å°‡ 
                        <span class="fw-bold text-dark" v-if="tempItemToRemove">{{ tempItemToRemove.name }}</span> 
                        å¾è³¼ç‰©è»Šç§»é™¤å—ï¼Ÿ
                    </p>

                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-light btn-lg px-4 fw-bold rounded-pill" @click="closeRemoveItemModal">
                            ä¿ç•™
                        </button>
                        <button type="button" class="btn btn-warning btn-lg px-4 fw-bold rounded-pill shadow text-dark" @click="executeRemoveItem">
                            ç¢ºèªç§»é™¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="notFoundModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow border-0">
                <div class="modal-body p-4 text-center">
                    
                    <div class="mb-3 text-secondary">
                        <div style="font-size: 4rem;">ğŸ¤”</div>
                    </div>

                    <h4 class="fw-bold mb-3 text-dark">æ‰¾ä¸åˆ°æ­¤å•†å“</h4>
                    
                    <p class="text-muted mb-4">
                        ç³»çµ±æ‰¾ä¸åˆ°ç·¨è™Ÿ 
                        <span class="fw-bold text-danger mx-1">{{ tempInvalidId }}</span> 
                        çš„å•†å“è³‡æ–™ï¼Œ<br>è«‹ç¢ºèªè¼¸å…¥æ˜¯å¦æ­£ç¢ºã€‚
                    </p>

                    <button type="button" class="btn btn-seven-green btn-lg px-5 fw-bold rounded-pill shadow" @click="closeNotFoundModal">
                        çŸ¥é“äº†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="orderHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content rounded-4 shadow border-0">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title fw-bold">ğŸ“‹ äº¤æ˜“ç´€éŒ„ (æœ€è¿‘è¨‚å–®)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    
                    <div v-if="orders.length === 0" class="text-center py-5 text-muted">
                        <div class="fs-1 mb-2">ğŸ“­</div>
                        ç›®å‰æ²’æœ‰ä»»ä½•äº¤æ˜“ç´€éŒ„
                    </div>

                    <div v-else class="list-group list-group-flush" style="max-height: 60vh; overflow-y: auto;">
    
                        <div class="list-group-item p-0 border-bottom" v-for="order in orders" :key="order.id">
                            
                            <div class="p-3 d-flex justify-content-between align-items-center bg-white">
                                <div>
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <span class="badge bg-dark" style="font-size: 1rem;">#{{ order.id }}</span>
                                        <span class="fw-bold fs-4 text-seven-green ms-2">${{ order.total_amount }}</span>
                                        <span class="badge bg-info text-dark">{{ order.customer_tag }}</span>
                                    </div>
                                    <small class="text-muted">ğŸ•’ {{ formatDate(order.sale_time) }}</small>
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-secondary btn-sm" @click="toggleDetails(order)">
                                        {{ order.showDetails ? 'â–² æ”¶èµ·' : 'ğŸ“„ æ˜ç´°' }}
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm fw-bold" @click="deleteOrder(order)">
                                        ğŸ—‘ï¸ ä½œå»¢
                                    </button>
                                </div>
                            </div>

                            <div v-if="order.showDetails" class="bg-light p-3 border-top inner-shadow">
                                
                                <div v-if="order.loading" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm" role="status"></div> è¼‰å…¥ä¸­...
                                </div>

                                <table v-else class="table table-sm table-borderless mb-0">
                                    <thead class="text-secondary border-bottom">
                                        <tr>
                                            <th>å•†å“åç¨±</th>
                                            <th class="text-center">å–®åƒ¹</th>
                                            <th class="text-center">æ•¸é‡</th>
                                            <th class="text-end">å°è¨ˆ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(item, i) in order.items" :key="i">
                                            <td>{{ item.name }}</td>
                                            <td class="text-center text-muted">${{ item.price }}</td>
                                            <td class="text-center fw-bold">x{{ item.quantity }}</td>
                                            <td class="text-end">${{ item.subtotal }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteOrderModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow border-0">
                <div class="modal-body p-4 text-center">
                    
                    <div class="mb-3 text-danger">
                        <div style="font-size: 4rem;">ğŸ—‘ï¸</div>
                    </div>

                    <h4 class="fw-bold mb-3 text-dark">ç¢ºå®šè¦ä½œå»¢æ­¤è¨‚å–®ï¼Ÿ</h4>
                    
                    <p class="text-muted mb-4">
                        è¨‚å–®ç·¨è™Ÿï¼š
                        <span class="fw-bold text-danger fs-5" v-if="tempOrderToDelete">
                            #<span v-text="tempOrderToDelete.id"></span>
                        </span>
                        <span class="small">ä½œå»¢å¾Œï¼Œå•†å“åº«å­˜å°‡æœƒ<strong class="text-success">è‡ªå‹•åŠ å›</strong>ã€‚</span>
                    </p>
                    

                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-light btn-lg px-4 fw-bold rounded-pill" @click="closeDeleteOrderModal">
                            å†æƒ³æƒ³
                        </button>
                        <button type="button" class="btn btn-danger btn-lg px-4 fw-bold rounded-pill shadow" @click="executeDeleteOrder">
                            ç¢ºèªä½œå»¢
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- å¼•å…¥ Vue, Axios, Bootstrap JS -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                // --- [é–‹ç™¼éšæ®µ] å‡è³‡æ–™ ---
                // ç­‰å¾Œç«¯ API å¯«å¥½å¾Œï¼Œé€™è£¡å¯ä»¥ç•™ç©º []ï¼Œæ”¹ç”¨ fetchProducts() å¡«å…¥
                cart: [],
                products: [],
                inputProductId: '', // ç”¨ä¾†ç¶å®šè¼¸å…¥æ¡†çš„è®Šæ•¸
                modalInstance: null,
                confirmModalInstance: null, // ç¢ºèªå½ˆçª—
                clearCartModalInstance: null,// æ¸…ç©ºè­¦å‘Šå½ˆçª—
                removeItemModalInstance: null, // æ§åˆ¶å½ˆçª—
                notFoundModalInstance: null, // æ§åˆ¶å½ˆçª—
                tempInvalidId: '',           // ç”¨ä¾†é¡¯ç¤ºå‰›å‰›è¼¸å…¥éŒ¯çš„è™Ÿç¢¼
                
                selectedCategory: 'å…¨éƒ¨',   // é è¨­é¸æ“‡ "å…¨éƒ¨" é¡åˆ¥
                tempItemToRemove: null,        // æš«å­˜è¦è¢«åˆªé™¤çš„é‚£å€‹å•†å“ç‰©ä»¶
                tempCustomerTag: '',         // ç”¨ä¾†æš«è¨˜ä½¿ç”¨è€…å‰›å‰›é»äº† "å­¸ç”Ÿ" é‚„æ˜¯ "ä¸Šç­æ—"
                lastOrder: {
                    customer: '',
                    total: 0
                },
                orders: [],                 // å­˜æ”¾æ‰€æœ‰è¨‚å–®
                orderHistoryModalInstance: null, // æ§åˆ¶äº¤æ˜“ç´€éŒ„å½ˆçª—
                deleteOrderModalInstance: null, // æ§åˆ¶ä½œå»¢å½ˆçª—
                tempOrderToDelete: null,        // æš«å­˜è¦è¢«ä½œå»¢çš„é‚£å¼µè¨‚å–®ç‰©ä»¶
            }
        },
        computed: {
            // è‡ªå‹•è¨ˆç®—ç¸½é‡‘é¡
            totalPrice() {
                return this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            },
            // è‡ªå‹•å¾å•†å“åˆ—è¡¨ä¸­æŠ“å‡ºæ‰€æœ‰çš„åˆ†é¡ (ä¸é‡è¤‡)
            categoryList() {
                // 1. å…ˆæŠ“å‡ºæ‰€æœ‰å•†å“çš„ category
                const categories = this.products.map(p => p.category);
                // 2. ç”¨ Set å»é™¤é‡è¤‡ï¼Œç„¶å¾Œè½‰å›é™£åˆ—
                // 3. åœ¨æœ€å‰é¢åŠ ä¸Š 'å…¨éƒ¨'
                return ['å…¨éƒ¨', ...new Set(categories)];
            },
            // æ ¹æ“šé¸ä¸­çš„åˆ†é¡ï¼Œéæ¿¾å‡ºè¦é¡¯ç¤ºçš„å•†å“
            filteredProducts() {
                if (this.selectedCategory === 'å…¨éƒ¨') {
                    return this.products; // å¦‚æœé¸å…¨éƒ¨ï¼Œå°±å›å‚³æ‰€æœ‰å•†å“
                }
                // å¦å‰‡åªå›å‚³ç¬¦åˆè©²åˆ†é¡çš„å•†å“
                return this.products.filter(p => p.category === this.selectedCategory);
            },
            // è‡ªå‹•è¨ˆç®—ç¸½ä»¶æ•¸
            cartTotalCount() {
                return this.cart.reduce((sum, item) => sum + item.quantity, 0);
            }
        },
        mounted() {
            // åˆå§‹åŒ– Bootstrap Modal
            this.modalInstance = new bootstrap.Modal(document.getElementById('checkoutModal'));
            // åˆå§‹åŒ–ç¢ºèªå½ˆçª—
            this.confirmModalInstance = new bootstrap.Modal(document.getElementById('confirmModal'));
            // åˆå§‹åŒ–æˆåŠŸå½ˆçª—
            this.successModalInstance = new bootstrap.Modal(document.getElementById('successModal'));
            // åˆå§‹åŒ–æ¸…ç©ºå½ˆçª—
            this.clearCartModalInstance = new bootstrap.Modal(document.getElementById('clearCartModal'));
            // åˆå§‹åŒ–ç§»é™¤å•†å“å½ˆçª—
            this.removeItemModalInstance = new bootstrap.Modal(document.getElementById('removeItemModal'));
            // åˆå§‹åŒ–æŸ¥ç„¡å•†å“å½ˆçª—
            this.notFoundModalInstance = new bootstrap.Modal(document.getElementById('notFoundModal'));
            // åˆå§‹åŒ–äº¤æ˜“ç´€éŒ„å½ˆçª—
            this.orderHistoryModalInstance = new bootstrap.Modal(document.getElementById('orderHistoryModal'));
            // åˆå§‹åŒ–ä½œå»¢å½ˆçª—
            this.deleteOrderModalInstance = new bootstrap.Modal(document.getElementById('deleteOrderModal'));
            // TODO: æ­£å¼ä¸²æ¥æ™‚ï¼Œè«‹æŠŠä¸‹é¢é€™è¡Œè¨»è§£æ‰“é–‹
            this.fetchProducts();
        },
        methods: {
            // --- 1. ä¸²æ¥å¾Œç«¯ APIï¼šå–å¾—å•†å“åˆ—è¡¨ ---
            fetchProducts() {
                // å‡è¨­ä½ çš„é›»è…¦ IP æ˜¯ 127.0.0.1ï¼Œä¹‹å¾Œè¦æ”¹æˆä¸»æ©Ÿçš„ IP
                axios.get('http://127.0.0.1:5000/api/products')
                    .then(response => {
                        this.products = response.data;
                        console.log(this.products);
                    })
                    .catch(error => {
                        console.error("ç„¡æ³•å–å¾—å•†å“è³‡æ–™:", error);
                        alert("é€£ç·šå¤±æ•—ï¼Œç›®å‰é¡¯ç¤ºå‡è³‡æ–™");
                    });
            },

            // --- 2. è³¼ç‰©è»Šé‚è¼¯ ---
            addToCart(product) {
                // if (product.current_stock <= 0) {
                //     alert(`âŒ ${product.name} åº«å­˜ä¸è¶³ï¼ç„¡æ³•åŠ å…¥`);
                //     return;
                // }
                
                // æª¢æŸ¥æ˜¯å¦å·²åœ¨è³¼ç‰©è»Š
                const existingItem = this.cart.find(item => item.id === product.id);
                
                if (existingItem) {
                    // // ç°¡å–®æª¢æŸ¥ï¼šè³¼ç‰©è»Šæ•¸é‡ä¸èƒ½è¶…éåº«å­˜
                    // // (æ³¨æ„ï¼šé€™åªæ˜¯å‰ç«¯é˜²å‘†ï¼Œå¾Œç«¯ API ä¹Ÿè¦å†æª¢æŸ¥ä¸€æ¬¡)
                    // if (existingItem.quantity < product.current_stock) {
                    //     existingItem.quantity++;
                    // } else {
                    //     alert("å·²é”åº«å­˜ä¸Šé™ï¼");
                    // }
                    existingItem.quantity++;
                } else {
                    this.cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: 1
                    });
                }
            },

            // --- æ–°å¢åŠŸèƒ½ï¼šé€éè¼¸å…¥ ID åŠ å…¥å•†å“ ---
            addProductById() {
                if (!this.inputProductId) return; // æ²’è¼¸å…¥å°±ä¸åšäº‹

                // æŠŠè¼¸å…¥è½‰æˆæ•¸å­— (å› ç‚º id æ˜¯æ•¸å­—)
                const targetId = parseInt(this.inputProductId);
                
                // åœ¨ products é™£åˆ—è£¡æ‰¾æœ‰æ²’æœ‰é€™å€‹ ID
                const product = this.products.find(p => p.id === targetId);

                if (product) {
                    this.addToCart(product); // æ‰¾åˆ°äº†ï¼åŠ å…¥è³¼ç‰©è»Š
                    this.inputProductId = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                } else {
                    // æŠŠè¼¸å…¥éŒ¯çš„è™Ÿç¢¼å­˜èµ·ä¾† (çµ¦ Modal é¡¯ç¤ºç”¨)
                    this.tempInvalidId = this.inputProductId;
                    // æ‰“é–‹ã€ŒæŸ¥ç„¡å•†å“ã€å½ˆçª—
                    this.notFoundModalInstance.show();
                    this.inputProductId = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                }
            },
            closeNotFoundModal() {
                this.notFoundModalInstance.hide();

                // ç¨å¾®å»¶é²ä¸€ä¸‹ï¼Œç­‰è¦–çª—é—œé–‰å‹•ç•«è·‘å®Œï¼ŒæŠŠæ¸¸æ¨™é–å›è¼¸å…¥æ¡†
                setTimeout(() => {
                    document.querySelector('.input-section input').focus();
                }, 300);
            },
            
            decreaseQty(item) {
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    this.tempItemToRemove = item;
                    // æ‰“é–‹ç¢ºèªå½ˆçª—
                    this.removeItemModalInstance.show();
                }
            },
            executeRemoveItem() {
                if (this.tempItemToRemove) {
                    // éæ¿¾æ‰è©²å•†å“
                    this.cart = this.cart.filter(c => c.id !== this.tempItemToRemove.id);
                    
                    // æ¸…ç©ºæš«å­˜
                    this.tempItemToRemove = null;
                }
                // é—œé–‰å½ˆçª—
                this.removeItemModalInstance.hide();
            },

            // é—œé–‰å½ˆçª— (æŒ‰ä¸‹ä¿ç•™æ™‚)
            closeRemoveItemModal() {
                this.tempItemToRemove = null; // æ¸…ç©ºæš«å­˜
                this.removeItemModalInstance.hide();
            },

            removeFromCart(index) {
                // this.cart.splice(index, 1);
                const item = this.cart[index];
                
                // 2. æŠŠé€™å€‹å•†å“å­˜åˆ°æš«å­˜å€ (çµ¦ Modal é¡¯ç¤ºåå­—ç”¨)
                this.tempItemToRemove = item;
                
                // 3. æ‰“é–‹å‰›å‰›åšå¥½çš„ã€Œç§»é™¤ç¢ºèªå½ˆçª—ã€
                this.removeItemModalInstance.show();
            },

            // (å–æ¶ˆæ•´ç­†è¨‚å–®
            clearCart() {
                // æ‰“é–‹ Modal
                this.clearCartModalInstance.show();
            },
            closeClearCartModal() {
                this.clearCartModalInstance.hide();
            },

            executeClearCart() {
                this.cart = [];
                this.closeClearCartModal();
            },

            showCheckoutModal() {
                this.modalInstance.show();
            },

            closeModal() {
                this.modalInstance.hide();
            },

            // ç¢ºèªçµå¸³æç¤º
            confirmSubmit(customerTag) {
                // 1. å…ˆæŠŠä½¿ç”¨è€…é¸çš„å®¢å±¤ (ä¾‹å¦‚ 'å­¸ç”Ÿ') å­˜èµ·ä¾†
                this.tempCustomerTag = customerTag;

                // 2. é—œé–‰ç›®å‰çš„ã€Œå®¢å±¤é¸æ“‡å½ˆçª—ã€
                this.modalInstance.hide();

                // 3. æ‰“é–‹æ–°çš„ã€Œç¢ºèªçµå¸³å½ˆçª—ã€
                // ä½¿ç”¨ setTimeout ç¨å¾®å»¶é²ä¸€é»é»ï¼Œè®“å‹•ç•«æ¯”è¼ƒé †æš¢ï¼Œé¿å…å…©å€‹é»‘åº•é‡ç–Š
                setTimeout(() => {
                    this.confirmModalInstance.show();
                }, 200);
            },

            // ä½¿ç”¨è€…æŒ‰ä¸‹ã€Œè¿”å›ä¿®æ”¹ã€æ™‚è§¸ç™¼
            closeConfirmModal() {
                // é—œé–‰ç›®å‰çš„ç¢ºèªè¦–çª—å°±å¥½
                this.confirmModalInstance.hide();

                // //å›åˆ°ä¸Šä¸€æ­¥é¸å®¢å±¤
                // this.modalInstance.show(); 
            },

            // ä½¿ç”¨è€…åœ¨ç¢ºèªå½ˆçª—æŒ‰ä¸‹ã€Œç¢ºèªçµå¸³ã€æ™‚è§¸ç™¼
            executeFinalSubmit() {
                // å‘¼å«åŸæœ¬å¯«å¥½çš„é€å‡ºé‚è¼¯ï¼Œä¸¦å‚³å…¥æˆ‘å€‘æš«å­˜çš„å®¢å±¤æ¨™ç±¤
                this.submitOrder(this.tempCustomerTag);
                
                // é—œé–‰ç¢ºèªå½ˆçª—
                this.confirmModalInstance.hide();
            },

            // --- 3. ä¸²æ¥å¾Œç«¯ APIï¼šé€å‡ºè¨‚å–® ---
            submitOrder(customerTag) {

                this.lastOrder = {
                    customer: customerTag,
                    total: this.totalPrice
                };
                
                const orderData = {
                    customer_tag: customerTag,
                    total_amount: this.totalPrice,
                    items: this.cart.map(item => ({
                        product_id: item.id,
                        quantity: item.quantity,
                        subtotal: item.price * item.quantity
                    }))
                };

                console.log("é€å‡ºè¨‚å–®:", orderData);

                // TODO: æ­£å¼ä¸²æ¥æ™‚ï¼Œè«‹æŠŠä¸‹é¢é€™æ®µæ‰“é–‹
                
                axios.post('http://127.0.0.1:5000/api/sales/checkout', orderData)
                    .then(response => {
                        // æˆåŠŸå¾Œï¼šæ¸…ç©ºè³¼ç‰©è»Šã€é—œé–‰è¦–çª—
                        this.cart = [];
                        this.closeModal();
                        
                        // é¡¯ç¤ºæˆåŠŸå½ˆçª—
                        this.successModalInstance.show();
                        
                        // ğŸ”¥ é‡è¦ï¼šé‡æ–°æŠ“å–å•†å“è³‡æ–™ (å› ç‚ºåº«å­˜è®Šäº†ï¼)
                        this.fetchProducts(); 
                    })
                    .catch(error => {
                        console.error(error);
                        alert("âŒ çµå¸³å¤±æ•—ï¼š" + error.message);
                    });
                

                // // --- æ¨¡æ“¬çµå¸³æˆåŠŸï¼Œä¸²æ¥å¾Œè«‹åˆªé™¤ ---
                // this.cart = [];
                // this.closeModal();

                // //æ‰“é–‹ã€Œçµå¸³æˆåŠŸã€å½ˆçª—
                // this.successModalInstance.show();
                
            },

            closeSuccessModal() {
                this.successModalInstance.hide();
                // é€™è£¡ä¸éœ€è¦åšä»»ä½•äº‹ï¼Œå› ç‚ºè³¼ç‰©è»Šå·²ç¶“æ¸…ç©ºäº†ï¼Œç›´æ¥å›åˆ°ä¸»ç•«é¢å³å¯
            },
            // 1. æ‰“é–‹äº¤æ˜“ç´€éŒ„è¦–çª— (ä¸¦æŠ“å–æœ€æ–°è³‡æ–™)
            openOrderHistory() {
                this.fetchOrders(); // å…ˆå»å¾Œç«¯æŠ“è³‡æ–™
                this.orderHistoryModalInstance.show(); // å†æ‰“é–‹è¦–çª—
            },

            // 2. å‘¼å«å¾Œç«¯ APIï¼šå–å¾—è¨‚å–®åˆ—è¡¨
            fetchOrders() {
                axios.get('http://127.0.0.1:5000/api/sales/orders')
                    .then(response => {
                        this.orders = response.data;
                    })
                    .catch(error => {
                        console.error("ç„¡æ³•å–å¾—è¨‚å–®:", error);
                        alert("ç„¡æ³•å–å¾—äº¤æ˜“ç´€éŒ„");
                    });
            },

            // 3. å‘¼å«å¾Œç«¯ APIï¼šä½œå»¢è¨‚å–®
            deleteOrder(order) {
                this.tempOrderToDelete = order;
                this.deleteOrderModalInstance.show();
            },

            // ä½¿ç”¨è€…åœ¨ä½œå»¢å½ˆçª—æŒ‰ä¸‹ã€Œç¢ºèªä½œå»¢ã€æ™‚è§¸ç™¼
            executeDeleteOrder() {

                // é˜²å‘†æª¢æŸ¥
                if (!this.tempOrderToDelete) {
                    console.error("éŒ¯èª¤ï¼šæ²’æœ‰é¸ä¸­ä»»ä½•è¨‚å–®");
                    return;
                }

                axios.delete(`http://127.0.0.1:5000/api/sales/orders/${this.tempOrderToDelete.id}`)
                    .then(response => {
                        // æˆåŠŸå¾Œè¦åšçš„äº‹
                        this.deleteOrderModalInstance.hide(); // é—œé–‰è¦–çª—
                        this.fetchOrders();   // æ›´æ–°è¨‚å–®åˆ—è¡¨
                        this.fetchProducts(); // æ›´æ–°å•†å“åº«å­˜

                    })
                    .catch(error => {
                        console.error("ä½œå»¢å¤±æ•—:", error);
                        const msg = error.response?.data?.message || error.message;
                        alert("âŒ ä½œå»¢å¤±æ•—ï¼š" + msg);
                    });
            },
            // é—œé–‰ä½œå»¢å½ˆçª—
            closeDeleteOrderModal() {
                this.tempOrderToDelete = null;
                this.deleteOrderModalInstance.hide();
            },
            
            // æ ¼å¼åŒ–æ™‚é–“çš„å°å·¥å…· (æŠŠé†œé†œçš„ SQL æ™‚é–“è®Šå¥½çœ‹)
            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('zh-TW', { hour12: false });
            },

            // åˆ‡æ›é¡¯ç¤º/éš±è—æ˜ç´°
            toggleDetails(order) {
                // å¦‚æœé€™å¼µè¨‚å–®å·²ç¶“æœ‰ items è³‡æ–™ä¸”æ˜¯å±•é–‹ç‹€æ…‹ -> æ”¶èµ·ä¾†
                if (order.showDetails) {
                    order.showDetails = false;
                    return; // çµæŸ
                }

                // å¦‚æœé‚„æ²’æŠ“éè³‡æ–™ -> å»å¾Œç«¯æŠ“
                // å…ˆçµ¦ä¸€å€‹ loading ç‹€æ…‹
                order.loading = true; 
                
                axios.get(`http://127.0.0.1:5000/api/sales/orders/${order.id}/items`)
                    .then(response => {
                        // Vue 3 çš„å¯«æ³•ï¼šç›´æ¥æŠŠæ–°å±¬æ€§å¡é€²å»ç‰©ä»¶è£¡
                        order.items = response.data;
                        order.showDetails = true; // è¨­å®šç‚ºå±•é–‹
                    })
                    .catch(error => {
                        console.error("æŠ“å–æ˜ç´°å¤±æ•—", error);
                        alert("ç„¡æ³•è®€å–æ˜ç´°");
                    })
                    .finally(() => {
                        order.loading = false;
                    });
            },
        }
    }).mount('#app')
</script>

{% endraw %}
</body>
</html>